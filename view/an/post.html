<!DOCTYPE html>
<html>
    <head>
        <script
            async
            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8112542064837410"
            crossorigin="anonymous"
        ></script>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
            crossorigin="anonymous"
        />
        <link href="/static/style.css" , rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title><%= data.title %></title>
        <meta property="og:title" content="애크미 익명 게시판" />
        <meta property="og:description" content="ㄹㅇㅋㅋ" />
        <style>
            textarea {
                background-color: var(--box-bg);
            }
        </style>
        <script
            src="https://kit.fontawesome.com/76a19131cd.js"
            crossorigin="anonymous"
            async
        ></script>
    </head>

    <body>
        <div class="container-xxl" style="height: 100%" id="main">
            <div class="row mb-2" style="height: 7em">
                <div
                    class="col p-4 mt-3 m-lg-3 shadow box"
                    style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    "
                >
                    <div>
                        <h2 style="margin: 0px">
                            <a class="btn btn-secondary" href="/an"><</a
                            ><strong id="school-grade-class"
                                ><%= data.title %></strong
                            >
                        </h2>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col p-4 mt-3 m-lg-3 shadow box">
                    <div style="float: left">
                        <img
                            class="rounded"
                            style="
                                width: 4rem;
                                height: 4rem;
                                margin-right: 1rem;
                            "
                            src="https://ssl.pstatic.net/static/pwe/address/img_profile.png"
                        />
                    </div>
                    <div>
                        <h5 style="margin: 0px; padding: 0px">익명</h5>
                        <p id="timestamp" style="color: gray"></p>
                    </div>

                    <hr />
                    <div class="p-3"><%- data.content %></div>
                    <hr />
                    <div class="p-3 pt-0">
                        <p>공유</p>
                        <a id="share-kakao" href="javascript:;">
                            <img
                                style="width: 2rem; height: 2rem"
                                src="https://developers.kakao.com/assets/img/about/logos/kakaolink/kakaolink_btn_medium.png"
                                alt="카카오톡으로 공유"
                            />
                        </a>
                        <a
                            class="ms-1"
                            id="share-link"
                            href="javascript:;"
                            onclick="copy('https:\/\/sol-studio.ga/post/<%= data._id %>')"
                        >
                            <img
                                style="width: 2rem; height: 2rem"
                                src="https://upload.wikimedia.org/wikipedia/commons/5/56/Chain_link_icon_slanted.png"
                            />
                        </a>
                        <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
                        <script type="text/javascript">
                            if (
                                window.matchMedia(
                                    "(prefers-color-scheme: dark)"
                                ).matches
                            ) {
                                document.querySelector(
                                    "#share-link"
                                ).style.filter = "invert()";
                            }
                            function copy(text) {
                                var tempElem =
                                    document.createElement("textarea");
                                tempElem.value = text;
                                document.body.appendChild(tempElem);

                                tempElem.select();
                                document.execCommand("copy");
                                document.body.removeChild(tempElem);
                                alert(
                                    "URL이 복사되었습니다. 원하시는 곳에 붙여넣어주세요."
                                );
                            }
                            Kakao.init("9110cc5f2159504e8844c4a23cea3929");
                            Kakao.isInitialized();
                            Kakao.Link.createDefaultButton({
                                container: "#share-kakao",
                                objectType: "text",
                                text: "글을 공유했습니다 : <%= data.title %>",
                                link: {
                                    mobileWebUrl:
                                        "https://sol-studio.ga/post/<%= data._id %>",
                                    webUrl: "https://sol-studio.ga/post/<%= data._id %>",
                                },
                            });
                        </script>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col pt-4 p-lg-4 mt-3 m-lg-3 shadow box">
                    <div>
                        <h2>댓글 달기</h2>
                        <textarea
                            id="content-"
                            style="width: 100%"
                            placeholder="댓글을 남겨보세요"
                        ></textarea>
                        <div
                            style="
                                display: flex;
                                justify-content: space-between;
                            "
                        >
                            <div></div>
                            <button
                                class="btn btn-primary"
                                onclick="addComment()"
                            >
                                등록
                            </button>
                        </div>
                    </div>
                    <div id="comment"></div>
                </div>
            </div>
        </div>
        <script src="https://momentjs.com/downloads/moment-with-locales.js"></script>
        <script>
            moment.locale("ko");
            document.querySelector("#timestamp").innerHTML = moment(new Date(<%= data.timestamp %>)).fromNow()
        </script>
        <script src="http://code.jquery.com/jquery-latest.min.js"></script>
        <script>
            var id = "<%= data._id %>";
            var user = {
                avatar: "https://ssl.pstatic.net/static/pwe/address/img_profile.png",
                name: "익명",
            };
            var loaded = 0;
            function loadComment(reply) {
                if (reply) {
                    var skip = replyStorage[reply] ?? 0;
                } else {
                    var skip = loaded;
                }
                $.ajax({
                    url: "/an/api/comment",
                    method: "GET",
                    data: {
                        id: id,
                        skip: skip,
                        reply: reply,
                    },
                    success: (data) => {
                        data.comment.forEach((d) => {
                            renderComment(d);
                        });
                        if (reply) {
                            if (!replyStorage[reply]) {
                                replyStorage[reply] = 0;
                            }
                            replyStorage[reply] += data.comment.length;
                            if (data.total > replyStorage[reply] * 30) {
                                $("#" + reply).append(`
                        <div class="mt-4 ms-5 p-1" id="more">
                            <div>
                                <button class="btn btn-primary" onclick="$('#more').remove();loadComment();">더보기</button>
                            </div>
                        </div>
                    `);
                            }
                        }
                        loaded += data.comment.length;
                        if (!reply && data.total > loaded) {
                            $("#comment").append(`
                    <div class="mt-4 p-1" id="more">
                        <div style="display: flex; justify-content: center;">
                            <button class="btn btn-primary" onclick="$('#more').remove();loadComment();">더보기</button>
                        </div>
                    </div>
                `);
                        }
                    },
                });
            }
            function addComment(reply) {
                var content = $(`#content-${reply ?? ""}`).val();
                if (!content) {
                    alert("내용을 입력해주세요.");
                    return;
                }

                $(`#content-${reply ?? ""}`).val("");

                $.ajax({
                    url: "/an/api/comment",
                    method: "POST",
                    data: {
                        id: id,
                        content: content,
                        reply: reply,
                    },
                    success: (data) => {
                        renderComment(data.comment);
                    },
                });
            }
            function xsssafe(content) {
                var result = "";

                result = content;
                result = result.replaceAll("<", "&lt;");
                result = result.replaceAll(">", "&gt;");

                return result;
            }
            function renderComment(d) {
                if (!d.reply) {
                    console.log("no reply");
                    $("#comment").append(`
            <div class="mt-4 p-1" id="${d._id}">
                <div style="display: flex;">
                    <img class="rounded" style="width: 2rem; height: 2rem; margin-right: 1rem;" src="https://ssl.pstatic.net/static/pwe/address/img_profile.png">
                    <h4 style="width: fit-content; margin: 0px; padding: 0px;"><strong>익명</strong></h4>
                </div>
                <div style="margin-left: 2rem">
                    <div class="p-3 pt-0 pb-1" style="font-size: large;">
                        ${xsssafe(d.content).replaceAll("\n", "<br>")}
                    </div>
                    <div class="p-3 pt-0" style="font-size: small; color: #888;">
                        ${moment(new Date(d.timestamp)).format(
                            "YYYY.MM.DD HH:mm"
                        )} ${replycount(
                        d
                    )} <span class="btn" style="color: #888" onclick="$('#reply-${
                        d._id
                    }').show()">답글 달기</span>
                    </div>
                    <div style="display: none;" id="reply-${d._id}">
                        <textarea style="width: 100%;" placeholder="댓글을 남겨보세요" id="content-${
                            d._id
                        }"></textarea>
                        <div style="display: flex;justify-content: space-between">
                            <div></div>
                            <div>
                                <button class="btn btn-secondary" style="color: #888" onclick="$('#reply-${
                                    d._id
                                }').hide()">닫기</button>
                                <button class="btn btn-primary" onclick="addComment('${
                                    d._id
                                }')">등록</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `);
                } else {
                    $("#" + d.reply).append(`
            <div class="ms-5 p-1" id="${d._id}">
                <div style="display: flex;">
                    <img class="rounded" style="width: 2rem; height: 2rem; margin-right: 1rem;" src="https://ssl.pstatic.net/static/pwe/address/img_profile.png">
                    <h4 style="width: fit-content; margin: 0px; padding: 0px;"><strong>익명</strong></h4>
                </div>
                <div style="margin-left: 2rem">
                    <div class="p-3 pt-0 pb-1" style="font-size: large;">
                        ${d.content}
                    </div>
                    <div class="p-3 pt-0" style="font-size: small; color: #888;">
                        ${moment(new Date(d.timestamp)).format(
                            "YYYY.MM.DD HH:mm"
                        )}
                    </div>
                </div>
            </div>
        `);
                }
            }
            function replycount(d) {
                if (d.reply_count > 0) {
                    return `<span class="btn" style="color: #888" onclick="loadComment('${d._id}'); $(event.target).remove()">답글 보기</span>`;
                } else {
                    return "";
                }
            }

            var replyStorage = {};
            loadComment();
        </script>
    </body>
</html>
