<!DOCTYPE html>
<html lang="en">
    <head>
        <%- include("../common/head.ejs") %>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>
        <title>Hello!</title>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="/static/style.css" , rel="stylesheet" />
        <script src="/static/common.js"></script>
        <script
            src="https://kit.fontawesome.com/76a19131cd.js"
            crossorigin="anonymous"
            async
        ></script>
        <script>
            function $(q) {
                var result = document.querySelectorAll(q);
                return result.length == 1 ? result[0] : result;
            }
        </script>
        <style>
            body {
                font-family: "Benton Sans", "Helvetica Neue", helvetica, arial,
                    sans-serif;
                margin: 2em;
            }

            .widget {
                cursor: move;
            }

            .widget.over {
                border: 3px dotted #666;
            }

            [draggable] {
                user-select: none;
            }
            #add {
                border: none;
                background: none;
                padding: 0px;
                height: 4rem;
            }
        </style>
    </head>
    <body>
        <%- include("../common/navbar.ejs") %>
        <div class="container">
            <div class="row">
                <div class="col">
                    <h2>라이브러리</h2>
                    <div class="library p-4" style="border-style: solid">
                        <div draggable="true" class="widget">
                            <div class="row p-4 mt-4 shadow box">
                                <div
                                    style="
                                        display: flex;
                                        justify-content: space-between;
                                    "
                                >
                                    <% if (user_type == "teacher") { %>
                                    <a href="/notice">
                                        <h3><strong>공지사항</strong></h3>
                                    </a>
                                    <% } %>
                                    <div>
                                        <a
                                            href="/new-notice"
                                            style="
                                                color: var(--link);
                                                display: none;
                                            "
                                        >
                                            <i class="fa fa-pencil"></i>
                                            공지 작성
                                        </a>
                                    </div>
                                </div>

                                <ul id="notice" class="list-group"></ul>
                                <script>
                                    async function fetchNotice() {
                                        $("#notice").innerHTML = "로드중...";

                                        fetch(`/api/notice?skip=0`, {
                                            method: "GET",
                                        })
                                            .then((response) => response.json())
                                            .then((data) => {
                                                if (data.success) {
                                                    $("#notice").innerHTML = "";
                                                    for (const d of data.notice) {
                                                        $(
                                                            "#notice"
                                                        ).insertAdjacentHTML(
                                                            "beforeend",
                                                            `<li class="list-group-item" onclick="openNotice('${d.id}')">${d.title}</li>`
                                                        );
                                                    }
                                                    if (
                                                        data.notice.length == 0
                                                    ) {
                                                        $(
                                                            "#notice"
                                                        ).insertAdjacentHTML(
                                                            "beforeend",
                                                            `<strong class="list-group-item">공지 없음</strong>`
                                                        );
                                                    }
                                                } else {
                                                    $("#notice").innerHTML =
                                                        "오류가 발생했습니다.";
                                                    throw Error(
                                                        data.message ??
                                                            "fetchNotice:success->false, no message"
                                                    );
                                                }
                                            });
                                    }
                                    fetchNotice();
                                </script>
                            </div>
                        </div>
                        <div draggable="true" class="widget">
                            <div class="row p-4 mt-4 shadow box">
                                <div
                                    style="
                                        display: flex;
                                        justify-content: space-between;
                                    "
                                >
                                    <a href="/post" style="width: fit-content">
                                        <h3
                                            style="
                                                display: inline-block;
                                                width: fit-content;
                                            "
                                        >
                                            <strong>게시물</strong>
                                        </h3>
                                    </a>
                                    <a
                                        href="/new-post"
                                        style="color: var(--link)"
                                    >
                                        <i class="fa fa-pencil"></i>
                                        게시물 작성
                                    </a>
                                </div>
                                <ul id="posts" class="list-group"></ul>
                                <script>
                                    async function fetchpost() {
                                        $("#posts").innerHTML = "로드중...";

                                        fetch(`/api/post?skip=0`, {
                                            method: "GET",
                                        })
                                            .then((d) => d.json())
                                            .then((data) => {
                                                if (data.success) {
                                                    $("#posts").innerHTML = "";
                                                    for (const d of data.post) {
                                                        $(
                                                            "#posts"
                                                        ).insertAdjacentHTML(
                                                            "beforeend",
                                                            `<li class="list-group-item" onclick="openPost('${d.id}')">${d.title}</li>`
                                                        );
                                                    }
                                                    if (data.post.length == 0) {
                                                        $(
                                                            "#posts"
                                                        ).insertAdjacentHTML(
                                                            "beforeend",
                                                            `<li class="list-group-item"><strong style="color: black;">게시글 없음</strong></li>`
                                                        );
                                                    }
                                                } else {
                                                    $(
                                                        "#posts"
                                                    ).insertAdjacentHTML(
                                                        "beforeend",
                                                        `<li class="list-group-item"><strong style="color: black;">오류 발생</strong></li>`
                                                    );
                                                    throw Error(
                                                        data.message ??
                                                            "fetchpost:success->false, no message"
                                                    );
                                                }
                                            });
                                    }
                                    function openPost(link) {
                                        location.href = "/post/" + link;
                                    }

                                    function newPost() {
                                        location.href = "/new-post";
                                    }
                                    fetchpost();
                                </script>
                            </div>
                        </div>
                        <div draggable="true" class="widget">
                            <div class="row p-4 mt-4 shadow box">
                                <div
                                    style="
                                        display: flex;
                                        justify-content: space-between;
                                    "
                                >
                                    <h3
                                        style="
                                            display: inline-block;
                                            width: fit-content;
                                            margin: 0px;
                                        "
                                    >
                                        <strong>주말</strong><br />
                                        D-1
                                    </h3>
                                </div>
                            </div>
                        </div>
                        <div draggable="true" class="widget">
                            <div class="row p-4 mt-4 mb-4 shadow box">
                                <div
                                    style="
                                        display: flex;
                                        justify-content: space-between;
                                    "
                                >
                                    <a
                                        href="/calendar"
                                        style="width: fit-content"
                                    >
                                        <h3
                                            style="
                                                display: inline-block;
                                                width: fit-content;
                                                margin: 0px;
                                            "
                                        >
                                            <strong>캘린더</strong>
                                        </h3>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <h2>사이드바</h2>
                    <div class="edit-area p-4" style="border-style: solid">
                        <div class="widget" id="add"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            var dragSrcEl = null;

            function handleDragStart(e) {
                if (!this.parentElement.classList.contains("library"))
                    this.style.opacity = "0.4";

                dragSrcEl = this;

                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("text/html", this.innerHTML);
            }

            function handleDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }

                e.dataTransfer.dropEffect = "move";

                return false;
            }

            function handleDragEnter(e) {
                if (e.target.id != "add") this.classList.add("over");
            }

            function handleDragLeave(e) {
                this.classList.remove("over");
            }

            function handleDrop(e) {
                if (e.stopPropagation) {
                    e.stopPropagation(); // stops the browser from redirecting.
                }

                if (dragSrcEl != this) {
                    if (!dragSrcEl.parentElement.classList.contains("library"))
                        dragSrcEl.innerHTML = this.innerHTML;
                    if (this.id == "add") {
                        let newWidget = document.createElement("div");
                        newWidget.classList.add("widget");
                        newWidget.innerHTML = this.innerHTML;
                        newWidget.id = "add";
                        this.id = "";
                        this.setAttribute("draggable", "true");
                        this.parentElement.append(newWidget);
                        newWidget.addEventListener(
                            "dragstart",
                            handleDragStart,
                            false
                        );
                        newWidget.addEventListener(
                            "dragenter",
                            handleDragEnter,
                            false
                        );
                        newWidget.addEventListener(
                            "dragover",
                            handleDragOver,
                            false
                        );
                        newWidget.addEventListener(
                            "dragleave",
                            handleDragLeave,
                            false
                        );
                        newWidget.addEventListener("drop", handleDrop, false);
                        newWidget.addEventListener(
                            "dragend",
                            handleDragEnd,
                            false
                        );
                        items.push(newWidget);
                    }

                    this.innerHTML = e.dataTransfer.getData("text/html");
                }

                return false;
            }

            function handleDragEnd(e) {
                this.style.opacity = "1";

                items.forEach(function (item) {
                    item.classList.remove("over");
                });
            }
            function libraryHandleDrop(e) {
                dragSrcEl.remove();
            }
            let library_items = document.querySelectorAll(".library .widget");
            library_items.forEach(function (item) {
                item.addEventListener("dragstart", handleDragStart, false);
                item.addEventListener("dragover", handleDragOver, false);
                item.addEventListener("drop", libraryHandleDrop, false);
            });
            let items = Array.from(
                document.querySelectorAll(".edit-area .widget")
            );
            items.forEach((item) => {
                item.addEventListener("dragstart", handleDragStart, false);
                item.addEventListener("dragenter", handleDragEnter, false);
                item.addEventListener("dragover", handleDragOver, false);
                item.addEventListener("dragleave", handleDragLeave, false);
                item.addEventListener("drop", handleDrop, false);
                item.addEventListener("dragend", handleDragEnd, false);
            });
        </script>
    </body>
</html>
