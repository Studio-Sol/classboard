<!DOCTYPE html>
<html>
    <head>
        <%- include("./common/head.ejs") %>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>공지 작성</title>

        <link href="/static/bootstrap.min.css" rel="stylesheet" />
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

        <link href="/static/style.css" rel="stylesheet" />

        <link
            href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css"
            rel="stylesheet"
        />
        <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>

        <style>
            input,
            select,
            option {
                background-color: var(--box-bg);
                border-style: solid;
                color: var(--text);
            }
            .btn-bs5-primary {
                background-color: var(--bs-primary);
                color: var(--bs-white);
            }
            .btn-bs5-secondary {
                background-color: var(--bs-secondary);
                color: var(--bs-white);
            }
        </style>
    </head>

    <body>
        <div
            id="reply-type-choose"
            style="
                display: none;
                background: rgba(0, 0, 0, 0.5);
                width: 100%;
                height: 100%;
                position: fixed;
                align-items: center;
                justify-content: center;
                z-index: 999;
            "
        >
            <div
                class="box shadow p-5 w-75 h-50"
                style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-direction: column;
                "
            >
                <h2>회신항목 추가</h2>
                <h4>회신 내용은 선생님만 확인 가능합니다</h4>
                <select class="form-select" id="reply-type">
                    <option value="null" selected>
                        회신 유형을 선택해주세요
                    </option>
                    <option value="text">텍스트형 응답</option>
                    <option value="select">선택형 응답</option>
                </select>
                <div
                    class="mt-3"
                    style="
                        display: flex;
                        width: 100%;
                        justify-content: flex-end;
                    "
                >
                    <button
                        class="btn btn-bs5-secondary me-3"
                        onclick="$('#reply-type-choose').css('display', 'none');"
                    >
                        취소
                    </button>
                    <button class="btn btn-bs5-primary" onclick="addReply();">
                        확인
                    </button>
                </div>
            </div>
        </div>
        <div class="container-xxl" style="height: 100%" id="main">
            <div class="row mb-2" style="height: 7em">
                <div
                    class="col p-lg-4 mt-3 m-lg-3 shadow box"
                    style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    "
                >
                    <div>
                        <h2 style="margin: 0px">
                            <strong id="school-grade-class"
                                >학급 공지 작성</strong
                            >
                        </h2>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col p-lg-4 mt-3 m-lg-3 shadow box">
                    <div>
                        <div class="p-3">
                            <input
                                type="text"
                                id="title"
                                name="title"
                                style="width: 100%; font-size: x-large"
                                placeholder="제목을 입력해주세요"
                            />
                        </div>
                        <div class="p-3">
                            <textarea id="summernote" name="content"></textarea>
                        </div>
                        <hr />
                        <div
                            class="p-3"
                            id="replies"
                            style="border-style: solid"
                        >
                            <button
                                class="btn btn-bs5-primary"
                                id="addReply"
                                onclick="event.preventDefault(); $('#reply-type-choose').css('display', 'flex'); $('#main').css('filter', 'blur(3px);')"
                            >
                                회신 추가
                            </button>
                        </div>
                        <hr />
                        <div class="p-3">
                            <div style="float: right">
                                <button class="btn btn-bs5-primary" id="submit">
                                    제출
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="/static/common.js"></script>
        <script src="/static/summer_note/lang/summernote-ko-KR.js"></script>

        <script>
            var token = "<%= token.token %>";
            $(document).ready(function () {
                //여기 아래 부분
                $("#summernote").summernote({
                    height: 300, // 에디터 높이
                    minHeight: null, // 최소 높이
                    maxHeight: null, // 최대 높이
                    focus: true, // 에디터 로딩후 포커스를 맞출지 여부
                    lang: "ko-KR", // 한글 설정
                    placeholder: "최대 4096자까지 작성할 수 있습니다", //placeholder 설정
                    callbacks: {
                        //여기 부분이 이미지를 첨부하는 부분
                        onImageUpload: function (files) {
                            uploadSummernoteImageFile(files[0], this);
                        },
                        onPaste: function (e) {
                            var clipboardData = e.originalEvent.clipboardData;
                            if (
                                clipboardData &&
                                clipboardData.items &&
                                clipboardData.items.length
                            ) {
                                var item = clipboardData.items[0];
                                if (
                                    item.kind === "file" &&
                                    item.type.indexOf("image/") !== -1
                                ) {
                                    e.preventDefault();
                                }
                            }
                        },
                    },
                });
                function uploadSummernoteImageFile(file, editor) {
                    data = new FormData();
                    data.append("file", file);
                    $.ajax({
                        data: data,
                        type: "POST",
                        url: "/api/upload-img?token=" + token,
                        contentType: false,
                        processData: false,
                        success: function (data) {
                            $(editor).summernote("insertImage", data.url);
                        },
                    });
                }
            });
            $("#submit").on("click", (event) => {
                if (
                    $("#summernote").summernote("code") == "<p><br></p>" ||
                    $("#title").val() == ""
                ) {
                    event.preventDefault();
                    alert("제목과 내용을 모두 입력해주세요.");
                    return false;
                }
                if (
                    $(
                        "<div>" + $("#summernote").summernote("code") + "</div>"
                    ).text().length > 4096
                ) {
                    event.preventDefault();
                    alert("내용은 4096자 이하만 가능합니다");
                    return false;
                }
                var question = null;
                if ($("#reply")) {
                    if ($("#reply-type").val() == "text") {
                        question = {
                            type: "text",
                            content: $("#reply-content").val(),
                        };
                    } else if ($("#reply-type").val() == "select") {
                        var items = [];
                        Array.from(
                            document.getElementById("reply-items").children
                        ).forEach((item) => {
                            items.push({
                                content: item.children[0].value,
                                limit: parseInt(item.children[1].value),
                            });
                        });
                        question = {
                            type: "select",
                            content: $("#reply-content").val(),
                            items: items,
                        };
                    }
                }
                $.ajax({
                    url: "/api/notice",
                    method: "POST",
                    data: {
                        body: JSON.stringify({
                            title: $("#title").val(),
                            content: $("#summernote").val(),
                            question: question,
                        }),
                    },
                    success: (data) => {
                        location = "/notice/" + data.id;
                    },
                    error: (err) => {
                        alert(
                            "오류가 발생했습니다. 잠시 후에 다시 시도해주세요."
                        );
                    },
                });
            });
            function addReply() {
                if ($("#reply-type").val() == "null") {
                    alert("회신 유형을 선택해주세요.");
                    return;
                }
                $("#reply-type-choose").css("display", "none");

                if ($("#reply").length != 0) {
                    alert("회신은 1개만 첨부할 수 있습니다.");
                    return;
                }
                $("#addReply").remove();
                if ($("#reply-type").val() == "text") {
                    $("#replies").append(`
                                   <div id="reply">
                                       <input id="reply-content" type="text" placeholder="질문을 입력해주세요">
                                   </div>
                               `);
                } else if ($("#reply-type").val() == "select") {
                    $("#replies").append(`
                                   <div id="reply">
                                       <input id="reply-content" type="text" placeholder="질문을 입력해주세요">
                                       <hr>
                                       <ul id="reply-items">
                                           <li><input type="text" value="옵션 1"><input type="number" max="100" placeholder="최대 응답수"></li>
                                       </ul>
                                       <button class="btn btn-bs5-primary" onclick="addOption(event);">옵션 추가</button>
                                       <button class="btn btn-bs5-secondary" onclick="$('#reply').remove();">회신 삭제</button>
                                   </div>
                               `);
                }
            }
            $("#reply-type-choose").on("click", (event) => {
                if (
                    event.target == document.querySelector("#reply-type-choose")
                ) {
                    $("#reply-type-choose").css("display", "none");
                }
            });
            var i = 2;
            function addOption(event) {
                event.preventDefault();
                if (i > 10) {
                    alert("옵션은 최대 10개까지만 가능합니다");
                    return;
                }
                $("#reply > ul").append(`
                               <li><input type="text" value="옵션 ${i}"><input type="number" max="100" placeholder="최대 응답수"></li>
                           `);
                i++;
            }
        </script>
    </body>
</html>
